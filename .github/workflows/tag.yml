name: Build and Push centroid-hmi Docker Image

on:
  workflow_dispatch:
  push:
    tags:
      - '*'

permissions:
  contents: write
  packages: write

jobs:
  retag-pubspec:
    runs-on: [self-hosted]
    container:
      image: ghcr.io/centroid-is/tfc-toolchain:latest
    steps:
      - name: Make safe directory
        run: git config --system --add safe.directory '*'
      - name: Checkout centroid-hmi
        uses: actions/checkout@v4

      - name: Update version in pubspec.yaml
        if: startsWith(github.ref, 'refs/tags/')
        shell: bash
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "Updating version to $TAG"

          # Extract version (remove 'v' prefix if present)
          VERSION=${TAG#v}

          # Convert tag to version format (e.g., 2025.11.8)
          # and extract build number if present (format: 2025.11.8+1)
          if [[ $VERSION == *"+"* ]]; then
            FLUTTER_VERSION=$VERSION
            BASE_VERSION=${VERSION%+*}
            BUILD_NUMBER=${VERSION#*+}
          else
            FLUTTER_VERSION="${VERSION}+1"
            BASE_VERSION=$VERSION
            BUILD_NUMBER=1
          fi

          # Update Flutter version
          sed -i "s/^version: .*/version: $FLUTTER_VERSION/" centroid-hmi/pubspec.yaml

          # Update Windows msix_version (format: 2025.11.8.0)
          MSIX_VERSION="${BASE_VERSION}.${BUILD_NUMBER}"
          sed -i "s/^  msix_version: .*/  msix_version: $MSIX_VERSION/" centroid-hmi/pubspec.yaml

          echo "Updated versions:"
          echo "  Flutter version: $FLUTTER_VERSION"
          echo "  Windows msix_version: $MSIX_VERSION"

      - name: Commit and push version changes
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add centroid-hmi/pubspec.yaml
          git commit -m "Update version to ${GITHUB_REF#refs/tags/}"
          git push origin HEAD:main
