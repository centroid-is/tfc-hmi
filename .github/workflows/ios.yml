name: iOS App Store Deployment

on:
  push:
    branches:
      - main
      - auto-deploy
  workflow_dispatch:
    inputs:
      submit_for_review:
        description: 'Submit to App Store for review after upload'
        required: true
        default: true
        type: boolean

permissions:
  contents: read

concurrency:
  group: ios-deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
      # ── Checkout ────────────────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4

      # ── Setup Flutter ───────────────────────────────────────────
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      # ── Flutter dependencies ────────────────────────────────────
      - name: Get Flutter dependencies
        working-directory: centroid-hmi
        run: flutter pub get

      # ── CocoaPods ───────────────────────────────────────────────
      - name: Install CocoaPods dependencies
        working-directory: centroid-hmi/ios
        run: pod install

      # ── Import signing certificate ──────────────────────────────
      - name: Install Apple certificate
        env:
          P12_BASE64: ${{ secrets.IOS_CERTIFICATE_P12_BASE64 }}
          P12_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ github.run_id }}
        run: |
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

          echo -n "$P12_BASE64" | base64 --decode -o $CERTIFICATE_PATH

          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          security import $CERTIFICATE_PATH \
            -P "$P12_PASSWORD" \
            -A \
            -t cert \
            -f pkcs12 \
            -k $KEYCHAIN_PATH
          security set-key-partition-list \
            -S apple-tool:,apple: \
            -k "$KEYCHAIN_PASSWORD" \
            $KEYCHAIN_PATH

          security list-keychain -d user -s $KEYCHAIN_PATH

      # ── Install provisioning profile ────────────────────────────
      - name: Install provisioning profile
        env:
          PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
        run: |
          PP_PATH=$RUNNER_TEMP/build_pp.mobileprovision
          echo -n "$PROVISIONING_PROFILE_BASE64" | base64 --decode -o $PP_PATH

          PP_UUID=$(/usr/libexec/PlistBuddy -c "Print :UUID" /dev/stdin \
            <<< $(security cms -D -i $PP_PATH))
          echo "PP_UUID=$PP_UUID" >> $GITHUB_ENV

          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles/$PP_UUID.mobileprovision

      # ── Configure manual code signing for CI ────────────────────
      - name: Configure manual code signing
        working-directory: centroid-hmi/ios
        run: |
          sed -i '' 's/CODE_SIGN_STYLE = Automatic/CODE_SIGN_STYLE = Manual/g' \
            Runner.xcodeproj/project.pbxproj

      # ── Create ExportOptions.plist ──────────────────────────────
      - name: Create ExportOptions.plist
        run: |
          cat > $RUNNER_TEMP/ExportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
            "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store</string>
            <key>teamID</key>
            <string>Q4FZLRTZ4M</string>
            <key>uploadBitcode</key>
            <false/>
            <key>uploadSymbols</key>
            <true/>
            <key>signingStyle</key>
            <string>manual</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>is.centroid.x</key>
              <string>${PP_UUID}</string>
            </dict>
          </dict>
          </plist>
          EOF

      # ── Setup App Store Connect API key ─────────────────────────
      - name: Setup App Store Connect API key
        env:
          API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
          API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
        run: |
          mkdir -p ~/private_keys
          echo -n "$API_KEY_BASE64" | base64 --decode \
            > ~/private_keys/AuthKey_${API_KEY_ID}.p8

      # ── Build IPA ───────────────────────────────────────────────
      - name: Build iOS IPA
        working-directory: centroid-hmi
        run: |
          flutter build ipa \
            --release \
            --build-number=${{ github.run_number }} \
            --export-options-plist=$RUNNER_TEMP/ExportOptions.plist

      # ── Upload IPA as artifact ──────────────────────────────────
      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: centroidx-ios-${{ github.run_number }}
          path: centroid-hmi/build/ios/ipa/*.ipa
          retention-days: 30

      # ── Upload to App Store Connect ─────────────────────────────
      - name: Upload to App Store Connect
        env:
          API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
        run: |
          xcrun altool --upload-app \
            --type ios \
            --file centroid-hmi/build/ios/ipa/*.ipa \
            --apiKey "$API_KEY_ID" \
            --apiIssuer "$API_ISSUER_ID"

      # ── Cleanup ─────────────────────────────────────────────────
      - name: Clean up keychain
        if: always()
        run: |
          security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true

      # ── Summary ─────────────────────────────────────────────────
      - name: Build summary
        run: |
          echo "## iOS Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build number**: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "- **Destination**: App Store Connect (submit for review: ${{ inputs.submit_for_review }})" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Destination**: TestFlight" >> $GITHUB_STEP_SUMMARY
          fi
